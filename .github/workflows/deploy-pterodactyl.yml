name: Deploy Pterodactyl Panel & Wings

on:
  workflow_dispatch:
    inputs:
      force_reinstall:
        description: 'Force reinstall (removes existing installation)'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy-pterodactyl:
    name: Install Pterodactyl Panel & Wings
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy Pterodactyl to Hetzner via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          PTERO_DB_PASSWORD: ${{ secrets.PTERO_DB_PASSWORD }}
          PTERO_ADMIN_EMAIL: ${{ secrets.PTERO_ADMIN_EMAIL }}
          PTERO_ADMIN_PASSWORD: ${{ secrets.PTERO_ADMIN_PASSWORD }}
          FORCE_REINSTALL: ${{ github.event.inputs.force_reinstall }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PTERO_DB_PASSWORD,PTERO_ADMIN_EMAIL,PTERO_ADMIN_PASSWORD,FORCE_REINSTALL
          script_stop: true
          timeout: 30m
          script: |
            set -euo pipefail
            
            echo "=========================================="
            echo "Pterodactyl Panel & Wings Installation"
            echo "=========================================="
            
            # Set default values for secrets if not provided
            PTERO_DB_PASSWORD="${PTERO_DB_PASSWORD:-PterodactylDBPass2024!}"
            PTERO_ADMIN_EMAIL="${PTERO_ADMIN_EMAIL:-admin@festas-builds.com}"
            PTERO_ADMIN_PASSWORD="${PTERO_ADMIN_PASSWORD:-PteroAdmin2024!}"
            
            # ==========================================
            # 1. Check if already installed (idempotent)
            # ==========================================
            echo "[1/9] Checking existing installation..."
            
            # Check for FORCE_REINSTALL environment variable to allow reinstallation
            if [[ "${FORCE_REINSTALL:-false}" == "true" ]]; then
              echo "⚠ FORCE_REINSTALL is set, removing existing installation..."
              
              # Stop services
              sudo systemctl stop pteroq || true
              sudo systemctl stop nginx || true
              
              # Remove application files
              sudo rm -rf /var/www/pterodactyl
              
              # Remove Nginx configuration
              sudo rm -f /etc/nginx/sites-enabled/pterodactyl.conf
              sudo rm -f /etc/nginx/sites-available/pterodactyl.conf
              
              # Clean database
              sudo mysql -e "DROP DATABASE IF EXISTS pterodactyl;" || true
              sudo mysql -e "DROP USER IF EXISTS 'ptero'@'127.0.0.1';" || true
              sudo mysql -e "DROP USER IF EXISTS 'ptero'@'localhost';" || true
              sudo mysql -e "DROP USER IF EXISTS 'pterodactyluser'@'127.0.0.1';" || true
              sudo mysql -e "DROP USER IF EXISTS 'pterodactyluser'@'localhost';" || true
              
              # Remove systemd services
              sudo systemctl disable pteroq || true
              sudo rm -f /etc/systemd/system/pteroq.service
              sudo systemctl daemon-reload
              
              # Remove cron job
              sudo crontab -u www-data -l 2>/dev/null | grep -v "pterodactyl/artisan schedule:run" | sudo crontab -u www-data - || true
              
              echo "✓ Previous installation removed"
            fi
            
            if [[ -f /var/www/pterodactyl/artisan ]]; then
              echo "⚠ Pterodactyl Panel already installed at /var/www/pterodactyl"
              echo "Skipping installation to prevent data loss."
              echo "To reinstall, set FORCE_REINSTALL=true and re-run this workflow."
              exit 0
            fi
            
            echo "✓ No existing installation found, proceeding..."
            
            # ==========================================
            # 2. System Setup
            # ==========================================
            echo "[2/9] Installing system dependencies..."
            
            # Update package list
            sudo apt-get update
            
            # Add PHP repository for 8.3
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository -y ppa:ondrej/php
            sudo apt-get update
            
            # Install PHP 8.3 and extensions
            sudo apt-get install -y php8.3 php8.3-cli php8.3-common php8.3-gd \
              php8.3-mysql php8.3-mbstring php8.3-bcmath php8.3-xml php8.3-fpm \
              php8.3-curl php8.3-zip php8.3-intl php8.3-sqlite3 php8.3-redis
            
            # Install Composer if not present
            if ! command -v composer &> /dev/null; then
              echo "Installing Composer..."
              curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
            fi
            
            # Install MariaDB if not present
            if ! command -v mysql &> /dev/null; then
              echo "Installing MariaDB..."
              sudo apt-get install -y mariadb-server mariadb-client
              sudo systemctl start mariadb
              sudo systemctl enable mariadb
            fi
            
            # Install Redis if not present
            if ! command -v redis-cli &> /dev/null; then
              echo "Installing Redis..."
              sudo apt-get install -y redis-server
              sudo systemctl start redis-server
              sudo systemctl enable redis-server
            fi
            
            # Install other dependencies
            sudo apt-get install -y curl tar unzip git
            
            echo "✓ System dependencies installed"
            
            # ==========================================
            # 3. Database Setup
            # ==========================================
            echo "[3/9] Setting up database..."
            
            # Create database
            sudo mysql -e "CREATE DATABASE IF NOT EXISTS pterodactyl;"
            
            # Create users for BOTH localhost and 127.0.0.1 (MySQL treats them differently!)
            # User for 127.0.0.1
            sudo mysql -e "CREATE USER IF NOT EXISTS 'ptero'@'127.0.0.1' IDENTIFIED BY '${PTERO_DB_PASSWORD}';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON pterodactyl.* TO 'ptero'@'127.0.0.1' WITH GRANT OPTION;"
            
            # User for localhost (this is what PHP often uses!)
            sudo mysql -e "CREATE USER IF NOT EXISTS 'ptero'@'localhost' IDENTIFIED BY '${PTERO_DB_PASSWORD}';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON pterodactyl.* TO 'ptero'@'localhost' WITH GRANT OPTION;"
            
            # Pterodactyl user for game server databases (both hosts)
            sudo mysql -e "CREATE USER IF NOT EXISTS 'pterodactyluser'@'127.0.0.1' IDENTIFIED BY '${PTERO_DB_PASSWORD}';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'pterodactyluser'@'127.0.0.1' WITH GRANT OPTION;"
            sudo mysql -e "CREATE USER IF NOT EXISTS 'pterodactyluser'@'localhost' IDENTIFIED BY '${PTERO_DB_PASSWORD}';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'pterodactyluser'@'localhost' WITH GRANT OPTION;"
            
            sudo mysql -e "FLUSH PRIVILEGES;"
            
            echo "✓ Database setup complete"
            
            # ==========================================
            # 4. Panel Installation
            # ==========================================
            echo "[4/9] Installing Pterodactyl Panel..."
            
            # Create directory
            sudo mkdir -p /var/www/pterodactyl
            cd /var/www/pterodactyl
            
            # Download Panel
            echo "Downloading latest Panel release..."
            PANEL_VERSION=$(curl -s https://api.github.com/repos/pterodactyl/panel/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
            echo "Latest version: ${PANEL_VERSION}"
            
            sudo curl -L -o panel.tar.gz "https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz"
            sudo tar -xzf panel.tar.gz
            sudo rm panel.tar.gz
            
            # Copy .env.example to .env BEFORE setting permissions
            sudo cp .env.example .env
            
            # Set permissions BEFORE running composer (this is critical!)
            sudo chown -R www-data:www-data /var/www/pterodactyl
            sudo chmod -R 755 /var/www/pterodactyl/storage /var/www/pterodactyl/bootstrap/cache
            
            # Create composer cache directories with proper permissions
            echo "Setting up composer cache directories..."
            sudo mkdir -p /var/www/.cache/composer
            sudo mkdir -p /var/www/.composer
            sudo chown -R www-data:www-data /var/www/.cache /var/www/.composer
            
            # Install composer dependencies as www-data (now has write permissions)
            echo "Installing composer dependencies..."
            cd /var/www/pterodactyl
            sudo -u www-data COMPOSER_HOME=/var/www/.composer composer install --no-dev --optimize-autoloader --no-interaction
            
            echo "✓ Panel files installed"
            
            # ==========================================
            # 5. Panel Configuration
            # ==========================================
            echo "[5/9] Configuring Panel..."
            
            # Generate application key (now .env file exists)
            sudo -u www-data php artisan key:generate --force
            
            # Configure .env file
            sudo -u www-data php artisan p:environment:setup \
              --url=https://panel.festas-builds.com \
              --timezone=Europe/Berlin \
              --cache=redis \
              --session=redis \
              --queue=redis \
              --redis-host=127.0.0.1 \
              --redis-pass= \
              --redis-port=6379 \
              --no-interaction
            
            # Configure database settings
            echo "Configuring database connection..."
            sudo -u www-data php artisan p:environment:database \
              --host=127.0.0.1 \
              --port=3306 \
              --database=pterodactyl \
              --username=ptero \
              --password="${PTERO_DB_PASSWORD}" \
              --no-interaction
            
            # Verify .env file has correct database credentials
            echo "Verifying .env database credentials..."
            if ! sudo grep -q "DB_USERNAME=ptero" /var/www/pterodactyl/.env; then
              echo "ERROR: .env file has incorrect DB_USERNAME!"
              echo "Expected: DB_USERNAME=ptero"
              echo "Current .env DB settings:"
              sudo grep DB_ /var/www/pterodactyl/.env || true
              exit 1
            fi
            echo "✓ .env credentials verified"
            
            # Verify database connection before proceeding
            echo "Verifying database connection..."
            if ! sudo -u www-data php artisan migrate:status 2>&1 | grep -q -E "Migration table created successfully|Migration name"; then
              echo "ERROR: Database connection failed. Checking .env file..."
              sudo cat /var/www/pterodactyl/.env | grep DB_ || true
              exit 1
            fi
            echo "✓ Database connection verified"
            
            # Configure mail settings (use default local mail)
            sudo -u www-data php artisan p:environment:mail \
              --driver=mail \
              --email=noreply@festas-builds.com \
              --from="Pterodactyl Panel" \
              --no-interaction
            
            echo "✓ Panel configuration complete"
            
            # ==========================================
            # 6. Database Migrations
            # ==========================================
            echo "[6/9] Running database migrations..."
            
            # Run migrations with proper error handling
            if ! sudo -u www-data php artisan migrate --seed --force; then
              echo "ERROR: Database migration failed!"
              echo "Checking database connection..."
              sudo mysql -e "SHOW GRANTS FOR 'ptero'@'localhost';" || true
              sudo mysql -e "SELECT user, host FROM mysql.user WHERE user='ptero';" || true
              echo "Checking .env file database settings..."
              sudo cat /var/www/pterodactyl/.env | grep DB_ || true
              exit 1
            fi
            
            # Verify migrations were successful
            echo "Verifying migrations..."
            if ! sudo mysql pterodactyl -e "SHOW TABLES;" | grep -q "settings"; then
              echo "ERROR: Migrations did not create expected tables!"
              sudo mysql pterodactyl -e "SHOW TABLES;" || true
              exit 1
            fi
            
            echo "✓ Database migrations complete and verified"
            
            # ==========================================
            # 7. Create Admin User
            # ==========================================
            echo "[7/9] Creating admin user..."
            
            # Create admin user (command handles existing users gracefully)
            sudo -u www-data php artisan p:user:make \
              --email="${PTERO_ADMIN_EMAIL}" \
              --username=admin \
              --name-first=Admin \
              --name-last=Festas \
              --password="${PTERO_ADMIN_PASSWORD}" \
              --admin=1 \
              --no-interaction || echo "⚠ User may already exist or creation failed, check manually"
            
            echo "✓ Admin user setup complete"
            
            # ==========================================
            # 8. Nginx Setup
            # ==========================================
            echo "[8/9] Setting up Nginx..."
            
            # Install Nginx if not present
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo apt-get install -y nginx
            fi
            
            # Stop Nginx before making configuration changes to prevent port conflicts
            echo "Stopping Nginx for configuration..."
            sudo systemctl stop nginx || true
            
            # Remove ALL default Nginx configurations to prevent port 80 conflicts
            echo "Removing default Nginx configurations..."
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo rm -f /etc/nginx/sites-available/default
            sudo rm -f /etc/nginx/conf.d/default.conf
            
            # Disable default server in nginx.conf if present
            if sudo grep -q "listen.*80" /etc/nginx/nginx.conf 2>/dev/null; then
              echo "⚠ Warning: /etc/nginx/nginx.conf contains port 80 configuration"
              echo "This may need manual cleanup if issues persist"
            fi
            
            # Check if port 8081 is already in use
            echo "Checking port 8081 availability..."
            if sudo lsof -i :8081 -t >/dev/null 2>&1; then
              echo "⚠ Port 8081 is already in use. Checking what's using it..."
              sudo lsof -i :8081 || true
              echo "ERROR: Port 8081 must be available for Nginx"
              exit 1
            fi
            
            # Create Nginx configuration using cat with proper escaping
            echo "Creating Nginx configuration for Pterodactyl..."
            sudo cat > /etc/nginx/sites-available/pterodactyl.conf << 'NGINX_EOF'
            server {
                listen 127.0.0.1:8081;
                server_name panel.festas-builds.com;
                root /var/www/pterodactyl/public;
                index index.php;
            
                access_log /var/log/nginx/pterodactyl.access.log;
                error_log /var/log/nginx/pterodactyl.error.log;
            
                client_max_body_size 100m;
                client_body_timeout 120s;
            
                sendfile off;
            
                location / {
                    try_files $uri $uri/ /index.php?$query_string;
                }
            
                location ~ \.php$ {
                    fastcgi_split_path_info ^(.+\.php)(/.+)$;
                    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
                    fastcgi_index index.php;
                    include fastcgi_params;
                    fastcgi_param PHP_VALUE "upload_max_filesize = 100M \n post_max_size=100M";
                    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                    fastcgi_param HTTP_PROXY "";
                    fastcgi_intercept_errors off;
                    fastcgi_buffer_size 16k;
                    fastcgi_buffers 4 16k;
                    fastcgi_connect_timeout 300;
                    fastcgi_send_timeout 300;
                    fastcgi_read_timeout 300;
                    include /etc/nginx/fastcgi_params;
                }
            
                location ~ /\.ht {
                    deny all;
                }
            }
            NGINX_EOF
            
            # Enable site
            sudo ln -sf /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/pterodactyl.conf
            
            # Test Nginx configuration
            echo "Testing Nginx configuration..."
            if ! sudo nginx -t; then
              echo "ERROR: Nginx configuration test failed!"
              exit 1
            fi
            
            # Enable and start/restart Nginx
            sudo systemctl enable nginx
            if ! sudo systemctl restart nginx; then
              echo "ERROR: Nginx failed to start!"
              echo "Checking Nginx status..."
              sudo systemctl status nginx --no-pager -l || true
              echo "Checking Nginx error log..."
              sudo tail -50 /var/log/nginx/error.log || true
              echo "Checking what's using port 8080..."
              sudo netstat -tlnp | grep 8080 || true
              exit 1
            fi
            
            # Verify Nginx is running and listening
            if ! sudo systemctl is-active --quiet nginx; then
              echo "ERROR: Nginx is not running after restart!"
              sudo systemctl status nginx --no-pager -l || true
              exit 1
            fi
            
            echo "✓ Nginx setup complete and verified"
            
            # ==========================================
            # 9. Systemd Services & Cron
            # ==========================================
            echo "[9/9] Setting up systemd services..."
            
            # Create pteroq service
            sudo tee /etc/systemd/system/pteroq.service > /dev/null <<'SERVICE_EOF'
            [Unit]
            Description=Pterodactyl Queue Worker
            After=redis-server.service
            
            [Service]
            User=www-data
            Group=www-data
            Restart=always
            ExecStart=/usr/bin/php /var/www/pterodactyl/artisan queue:work --queue=high,standard,low --sleep=3 --tries=3
            StartLimitInterval=180
            StartLimitBurst=30
            RestartSec=5s
            
            [Install]
            WantedBy=multi-user.target
            SERVICE_EOF
            
            # Enable and start pteroq
            sudo systemctl enable pteroq.service
            sudo systemctl start pteroq.service
            
            # Add cron job for schedule (check if already exists to maintain idempotency)
            CRON_CMD="* * * * * php /var/www/pterodactyl/artisan schedule:run >> /dev/null 2>&1"
            if ! sudo crontab -u www-data -l 2>/dev/null | grep -q "pterodactyl/artisan schedule:run"; then
              (sudo crontab -u www-data -l 2>/dev/null || true; echo "${CRON_CMD}") | sudo crontab -u www-data -
              echo "✓ Cron job added"
            else
              echo "✓ Cron job already exists"
            fi
            
            echo "✓ Systemd services configured"
            
            # ==========================================
            # 10. Wings Installation
            # ==========================================
            echo "[10/10] Installing Wings..."
            
            # Create pterodactyl directory
            sudo mkdir -p /etc/pterodactyl
            
            # Download Wings
            WINGS_VERSION=$(curl -s https://api.github.com/repos/pterodactyl/wings/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
            echo "Downloading Wings ${WINGS_VERSION}..."
            sudo curl -L -o /usr/local/bin/wings "https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_amd64"
            sudo chmod +x /usr/local/bin/wings
            
            # Create Wings systemd service
            sudo tee /etc/systemd/system/wings.service > /dev/null <<'WINGS_EOF'
            [Unit]
            Description=Pterodactyl Wings Daemon
            After=docker.service
            Requires=docker.service
            PartOf=docker.service
            
            [Service]
            User=root
            WorkingDirectory=/etc/pterodactyl
            LimitNOFILE=4096
            PIDFile=/var/run/wings/daemon.pid
            ExecStart=/usr/local/bin/wings
            Restart=on-failure
            StartLimitInterval=180
            StartLimitBurst=30
            RestartSec=5s
            
            [Install]
            WantedBy=multi-user.target
            WINGS_EOF
            
            # Enable Wings service (but don't start - needs manual token configuration)
            sudo systemctl enable wings.service
            
            echo "✓ Wings installed (not started - needs manual token configuration)"
            
            # ==========================================
            # 11. Set Final Permissions
            # ==========================================
            echo "Setting final permissions..."
            
            sudo chown -R www-data:www-data /var/www/pterodactyl
            sudo chmod -R 755 /var/www/pterodactyl/storage
            sudo chmod -R 755 /var/www/pterodactyl/bootstrap/cache
            
            echo "✓ Permissions set"
            
            # ==========================================
            # Final Status & Verification
            # ==========================================
            echo ""
            echo "=========================================="
            echo "Installation Complete - Running Verification"
            echo "=========================================="
            echo ""
            
            # Verify all critical services are running
            FAILED_SERVICES=""
            
            echo "Checking services status..."
            if ! sudo systemctl is-active --quiet nginx; then
              echo "❌ Nginx is NOT running"
              FAILED_SERVICES="${FAILED_SERVICES}nginx "
            else
              echo "✓ Nginx is running"
            fi
            
            if ! sudo systemctl is-active --quiet php8.3-fpm; then
              echo "❌ PHP-FPM is NOT running"
              FAILED_SERVICES="${FAILED_SERVICES}php8.3-fpm "
            else
              echo "✓ PHP-FPM is running"
            fi
            
            if ! sudo systemctl is-active --quiet pteroq; then
              echo "❌ Pterodactyl Queue is NOT running"
              FAILED_SERVICES="${FAILED_SERVICES}pteroq "
            else
              echo "✓ Pterodactyl Queue is running"
            fi
            
            if ! sudo systemctl is-active --quiet mariadb; then
              echo "❌ MariaDB is NOT running"
              FAILED_SERVICES="${FAILED_SERVICES}mariadb "
            else
              echo "✓ MariaDB is running"
            fi
            
            if ! sudo systemctl is-active --quiet redis-server; then
              echo "❌ Redis is NOT running"
              FAILED_SERVICES="${FAILED_SERVICES}redis "
            else
              echo "✓ Redis is running"
            fi
            
            # Check if Nginx is listening on 8081
            echo ""
            echo "Checking Nginx port binding..."
            if sudo netstat -tlnp | grep "127.0.0.1:8081" | grep -q nginx; then
              echo "✓ Nginx is listening on 127.0.0.1:8081"
            else
              echo "❌ Nginx is NOT listening on 127.0.0.1:8081"
              sudo netstat -tlnp | grep 8081 || echo "Port 8081 not in use by any service"
              FAILED_SERVICES="${FAILED_SERVICES}nginx-port "
            fi
            
            # Test database connection
            echo ""
            echo "Testing database connection..."
            # Use environment variable to avoid password exposure in process list
            if sudo MYSQL_PWD="${PTERO_DB_PASSWORD}" mysql -u ptero pterodactyl -e "SELECT COUNT(*) FROM settings;" >/dev/null 2>&1; then
              echo "✓ Database connection successful"
            else
              echo "❌ Database connection failed"
              FAILED_SERVICES="${FAILED_SERVICES}database "
            fi
            
            # Check critical directories
            echo ""
            echo "Verifying file permissions..."
            if [[ -w /var/www/pterodactyl/storage ]]; then
              echo "✓ Storage directory is writable"
            else
              echo "❌ Storage directory is NOT writable"
              FAILED_SERVICES="${FAILED_SERVICES}permissions "
            fi
            
            # If any service failed, show details and exit with error
            if [[ -n "${FAILED_SERVICES}" ]]; then
              echo ""
              echo "=========================================="
              echo "⚠ Installation completed with ERRORS"
              echo "=========================================="
              echo "Failed components: ${FAILED_SERVICES}"
              echo ""
              echo "Service Details:"
              sudo systemctl status nginx --no-pager -l || true
              sudo systemctl status php8.3-fpm --no-pager -l || true
              sudo systemctl status pteroq --no-pager -l || true
              exit 1
            fi
            
            echo ""
            echo "=========================================="
            echo "✓ All Verification Checks Passed!"
            echo "=========================================="
            echo ""
            echo "Panel URL: https://panel.festas-builds.com"
            echo "Admin Email: ${PTERO_ADMIN_EMAIL}"
            echo ""
            echo "Services Status:"
            sudo systemctl status nginx --no-pager -l || true
            sudo systemctl status php8.3-fpm --no-pager -l || true
            sudo systemctl status pteroq --no-pager -l || true
            echo ""
            echo "Next Steps:"
            echo "1. Ensure DNS A-record for panel.festas-builds.com points to this server"
            echo "2. Caddy should already be configured (Caddyfile includes panel.festas-builds.com)"
            echo "3. Reload Caddy if it's running: docker compose exec caddy caddy reload"
            echo "4. Log into the panel at https://panel.festas-builds.com"
            echo "5. Create a Location and Node in the admin panel"
            echo "6. Generate Wings token and configure Wings"
            echo ""
            echo "See docs/PTERODACTYL_SETUP.md for detailed instructions"
            echo "=========================================="
