name: Deploy Pterodactyl Panel & Wings

on:
  workflow_dispatch:
    inputs:
      force_reinstall:
        description: 'Force reinstall (removes existing installation)'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy-pterodactyl:
    name: Install Pterodactyl Panel & Wings
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload deployment script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "scripts/deploy-pterodactyl.sh"
          target: "/tmp/"
          strip_components: 1
      
      - name: Deploy Pterodactyl to Hetzner via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          PTERO_DB_PASSWORD: ${{ secrets.PTERO_DB_PASSWORD }}
          PTERO_ADMIN_EMAIL: ${{ secrets.PTERO_ADMIN_EMAIL }}
          PTERO_ADMIN_PASSWORD: ${{ secrets.PTERO_ADMIN_PASSWORD }}
          FORCE_REINSTALL: ${{ github.event.inputs.force_reinstall }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PTERO_DB_PASSWORD,PTERO_ADMIN_EMAIL,PTERO_ADMIN_PASSWORD,FORCE_REINSTALL
          script_stop: true
          timeout: 30m
          script: |
            set -euo pipefail
            chmod +x /tmp/deploy-pterodactyl.sh
            /tmp/deploy-pterodactyl.sh
