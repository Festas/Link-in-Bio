name: Deploy to Hetzner via GHCR

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image details
        run: |
          echo "Image pushed successfully!"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  deploy:
    name: Deploy to Hetzner Server
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout repository (for Caddyfile)
        uses: actions/checkout@v4

      - name: Deploy to Hetzner via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Full SHA - will be truncated in script to match docker/metadata-action short SHA format
          IMAGE_SHA: ${{ github.sha }}
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository }}
          DOMAIN: ${{ secrets.DOMAIN }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          INSTAGRAM_SECRET: ${{ secrets.INSTAGRAM_SECRET }}
          TIKTOK_SECRET: ${{ secrets.TIKTOK_SECRET }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE_SHA,REGISTRY,IMAGE_NAME,DOMAIN,ENV_FILE,INSTAGRAM_SECRET,TIKTOK_SECRET,GHCR_TOKEN,GHCR_ACTOR
          script_stop: true
          script: |
            set -euo pipefail
            
            # Convert image name to lowercase (GHCR requirement)
            IMAGE_NAME_LOWER=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
            
            # Use short SHA (7 chars) to match docker/metadata-action output
            IMAGE_TAG="${IMAGE_SHA:0:7}"
            
            echo "=========================================="
            echo "Starting Link-in-Bio Deployment"
            echo "=========================================="
            echo "Image: ${REGISTRY}/${IMAGE_NAME_LOWER}:${IMAGE_TAG}"
            echo "Domain: ${DOMAIN:-not set}"
            echo ""
            
            # ==========================================
            # 1. Setup deployment directory
            # ==========================================
            echo "[1/6] Setting up deployment directory..."
            APP_DIR="/srv/link-in-bio"
            
            # Create directory if missing (handles empty server)
            sudo mkdir -p "${APP_DIR}"
            sudo mkdir -p "${APP_DIR}/data"
            sudo mkdir -p "${APP_DIR}/static/uploads"
            sudo mkdir -p "${APP_DIR}/caddy_data"
            sudo mkdir -p "${APP_DIR}/caddy_config"
            
            # Ensure current user owns the directory
            sudo chown -R $(whoami):$(whoami) "${APP_DIR}"
            
            cd "${APP_DIR}"
            echo "✓ Directory setup complete"
            
            # ==========================================
            # 2. Write .env file from secrets
            # ==========================================
            echo "[2/6] Writing .env file..."
            
            if [[ -n "${ENV_FILE:-}" ]]; then
              echo "${ENV_FILE}" > .env
              chmod 600 .env
              echo "✓ .env file created"
            else
              echo "⚠ Warning: ENV_FILE secret is not set"
              # Create minimal .env if not exists
              if [[ ! -f .env ]]; then
                echo "APP_DOMAIN=${DOMAIN:-localhost}" > .env
                chmod 600 .env
                echo "✓ Minimal .env file created"
              fi
            fi
            
            # Create .env.social file
            > .env.social
            if [[ -n "${INSTAGRAM_SECRET:-}" ]]; then
              echo "${INSTAGRAM_SECRET}" >> .env.social
              echo "" >> .env.social
            fi
            if [[ -n "${TIKTOK_SECRET:-}" ]]; then
              echo "${TIKTOK_SECRET}" >> .env.social
            fi
            chmod 600 .env.social
            echo "✓ .env.social file created"
            
            # ==========================================
            # 3. Write Caddyfile
            # ==========================================
            echo "[3/6] Writing Caddyfile..."
            
            if [[ -n "${DOMAIN:-}" ]]; then
              printf '%s\n' \
                "# Main domain - public-facing Link-in-Bio site" \
                "${DOMAIN} {" \
                "    tls eric@festas-builds.com" \
                "    reverse_proxy web:8000" \
                "}" \
                "" \
                "# Admin subdomain - administrative interface" \
                "admin.${DOMAIN} {" \
                "    tls eric@festas-builds.com" \
                "    reverse_proxy web:8000" \
                "}" \
                "" \
                "# RigPilot subdomain - PC Builder application" \
                "rigpilot.${DOMAIN} {" \
                "    tls eric@festas-builds.com" \
                "    encode gzip zstd" \
                "    # Cache static Next.js assets with immutable cache headers" \
                "    @static path /_next/static/*" \
                "    header @static Cache-Control \"public, max-age=31536000, immutable\"" \
                "    reverse_proxy rigpilot:3000" \
                "}" \
                > Caddyfile
              echo "✓ Caddyfile created for domain: ${DOMAIN} (with rigpilot subdomain)"
            else
              echo "⚠ Warning: DOMAIN secret is not set, using localhost"
              printf '%s\n' ":80 {" "    reverse_proxy web:8000" "}" > Caddyfile
              echo "✓ Caddyfile created for localhost"
            fi
            
            # ==========================================
            # 4. Write docker-compose.yml
            # ==========================================
            echo "[4/6] Writing docker-compose.yml..."
            
            # Use printf to avoid heredoc line injection by SSH action
            COMPOSE_IMAGE="${REGISTRY}/${IMAGE_NAME_LOWER}:${IMAGE_TAG}"
            printf '%s\n' \
              "version: \"3.8\"" \
              "services:" \
              "  web:" \
              "    image: \"${COMPOSE_IMAGE}\"" \
              "    container_name: linktree_app" \
              "    restart: unless-stopped" \
              "    volumes:" \
              "      - ./data:/app/data" \
              "      - ./static/uploads:/app/static/uploads" \
              "      - ./.env:/app/.env:ro" \
              "      - ./.env.social:/app/.env.social:ro" \
              "    healthcheck:" \
              "      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8000/health\"]" \
              "      interval: 30s" \
              "      timeout: 10s" \
              "      retries: 3" \
              "      start_period: 40s" \
              "    networks:" \
              "      - caddy-network" \
              "" \
              "  caddy:" \
              "    image: caddy:latest" \
              "    container_name: caddy_server" \
              "    restart: unless-stopped" \
              "    ports:" \
              "      - \"80:80\"" \
              "      - \"443:443\"" \
              "    volumes:" \
              "      - ./Caddyfile:/etc/caddy/Caddyfile:ro" \
              "      - ./caddy_data:/data" \
              "      - ./caddy_config:/config" \
              "    depends_on:" \
              "      - web" \
              "    networks:" \
              "      - caddy-network" \
              "" \
              "volumes:" \
              "  caddy_data:" \
              "  caddy_config:" \
              "" \
              "networks:" \
              "  caddy-network:" \
              "    name: caddy-network" \
              "    driver: bridge" \
              > docker-compose.yml
            
            # Validate docker-compose.yml and show contents on error
            if ! docker compose -f docker-compose.yml config > /dev/null 2>&1; then
              echo "⚠ Invalid docker-compose.yml generated, dumping contents for debugging:"
              sed -n '1,300p' docker-compose.yml || true
              echo "--- docker-compose config output (parser error details): ---"
              docker compose -f docker-compose.yml config || true
              exit 1
            fi
            
            echo "✓ docker-compose.yml created"
            
            # ==========================================
            # 5. Pull and deploy containers
            # ==========================================
            echo "[5/6] Pulling and deploying containers..."
            
            # Login to GHCR using GitHub token passed via env
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_ACTOR}" --password-stdin
            
            # Pull the new image
            docker compose pull
            
            # Start/update containers
            docker compose up -d --remove-orphans
            
            # Wait for containers to be healthy
            echo "Waiting for containers to be healthy..."
            sleep 10
            
            # Check container status
            RUNNING_CONTAINERS=$(docker compose ps --services --filter status=running | wc -l)
            if [[ "$RUNNING_CONTAINERS" -ge 2 ]]; then
              echo "✓ All containers are running ($RUNNING_CONTAINERS services)"
            else
              echo "⚠ Not all containers are running (only $RUNNING_CONTAINERS of 2)"
              docker compose ps
              docker compose logs --tail=50
              exit 1
            fi
            
            # ==========================================
            # 6. Run database migrations
            # ==========================================
            echo "[6/6] Running database migrations..."
            
            # Run migrations, but make sure the container loads the mounted .env first.
            MIGRATE_CMD='set -o allexport && test -f /app/.env && . /app/.env || true && set +o allexport && if which alembic > /dev/null 2>&1; then alembic upgrade head; else python init_databases.py; fi'
            if docker compose exec -T web sh -lc "$MIGRATE_CMD"; then
              echo "✓ Database migrations completed"
            else
              echo "⚠ Database migrations failed. Showing web container logs for debugging:"
              docker compose logs --tail=200 web || true
              exit 1
            fi
            
            # ==========================================
            # Final status
            # ==========================================
            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
            docker compose ps
            echo ""
            echo "Application URL: https://${DOMAIN:-localhost}"
            echo "Admin URL: https://admin.${DOMAIN:-localhost}"
            
            # Cleanup old images
            docker image prune -f || true

      - name: Show deployment failure logs
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=========================================="
            echo "Deployment failed - showing logs"
            echo "=========================================="
            cd /srv/link-in-bio || exit 0
            echo ""
            echo "=== Container Status ==="
            docker compose ps || true
            echo ""
            echo "=== Web Container Logs ==="
            docker compose logs --tail=100 web || true
            echo ""
            echo "=== Caddy Container Logs ==="
            docker compose logs --tail=50 caddy || true
            echo ""
            echo "=== Directory Contents ==="
            ls -la || true
            echo ""
            echo "=== .env file exists? ==="
            test -f .env && echo "Yes" || echo "No"
            echo ""
            echo "=== .env.social file exists? ==="
            test -f .env.social && echo "Yes" || echo "No"
