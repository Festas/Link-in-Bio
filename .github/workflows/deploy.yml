name: Deploy to Hetzner

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Alte Docker Container stoppen und entfernen
      - name: Stop and remove existing Docker containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Stoppe existierende Docker Container ==="
            cd /lib 2>/dev/null || true
            
            # Stoppe und entferne Container falls vorhanden
            if [ -f docker-compose.yml ]; then
              docker compose down --remove-orphans 2>/dev/null || true
              echo "✓ Container gestoppt"
            else
              echo "ℹ Keine bestehenden Container gefunden"
            fi

      # 2. Zielverzeichnis vorbereiten und alte Dateien bereinigen
      - name: Prepare target directory and cleanup old files
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Bereite Zielverzeichnis vor ==="
            
            # Erstelle /lib falls nicht vorhanden
            mkdir -p /lib
            
            # Sichere persistente Daten (data/, static/uploads/, .env Dateien)
            echo "ℹ Sichere persistente Daten..."
            if [ -d /lib/data ]; then
              mv /lib/data /tmp/lib_data_backup 2>/dev/null || true
            fi
            if [ -d /lib/static/uploads ] && [ "$(ls -A /lib/static/uploads 2>/dev/null)" ]; then
              mkdir -p /tmp/lib_uploads_backup
              cp -r /lib/static/uploads/* /tmp/lib_uploads_backup/
            fi
            if [ -f /lib/.env ]; then
              cp /lib/.env /tmp/lib_env_backup 2>/dev/null || true
            fi
            if [ -f /lib/.env.social ]; then
              cp /lib/.env.social /tmp/lib_env_social_backup 2>/dev/null || true
            fi
            
            # Bereinige alle alten Dateien (außer versteckte)
            echo "ℹ Bereinige alte Dateien..."
            find /lib -mindepth 1 -maxdepth 1 ! -name '.*' -exec rm -rf {} + 2>/dev/null || true
            
            # Stelle persistente Daten wieder her
            echo "ℹ Stelle persistente Daten wieder her..."
            if [ -d /tmp/lib_data_backup ]; then
              mv /tmp/lib_data_backup /lib/data 2>/dev/null || true
            fi
            if [ -d /tmp/lib_uploads_backup ] && [ "$(ls -A /tmp/lib_uploads_backup 2>/dev/null)" ]; then
              mkdir -p /lib/static/uploads
              cp -r /tmp/lib_uploads_backup/* /lib/static/uploads/
              rm -rf /tmp/lib_uploads_backup
            fi
            if [ -f /tmp/lib_env_backup ]; then
              mv /tmp/lib_env_backup /lib/.env 2>/dev/null || true
            fi
            if [ -f /tmp/lib_env_social_backup ]; then
              mv /tmp/lib_env_social_backup /lib/.env.social 2>/dev/null || true
            fi
            
            echo "✓ Zielverzeichnis vorbereitet"

      # 3. Nur benötigte Dateien auf den Server kopieren
      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/lib"
          rm: false
          # Ausschließen: DB-Dateien, Uploads, Git, Tests, Dev-Dateien, Archiv-Docs, nicht benötigte Dateien
          exclude: "data/,static/uploads/,venv/,.git/,.github/,tests/,docs/archive/,.pytest_cache/,.mypy_cache/,htmlcov/,*.pyc,__pycache__/,.env,.env.example,.env.social,.env.social.example,Makefile,.flake8,pyproject.toml,mediakit/Instagram/,mediakit/generated/,test_*.py,*_test.py,setup_enhanced.py,setup_social_media.py,CONTRIBUTING.md,CHANGELOG.md,LICENSE,*.log,*.tmp,*.temp,.coverage,.coverage.*,.hypothesis/,.tox/,.nox/,coverage.xml,*.cover,.DS_Store,Thumbs.db,*.swp,*.swo,alembic/"

      # 4. Alle .env Dateien aus GitHub Secrets erstellen (ersetzt existierende)
      - name: Create all .env files from secrets
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Erstelle .env Dateien ==="
            cd /lib
            
            # Haupt-.env Datei erstellen (wird immer ersetzt)
            echo "${{ secrets.ENV_FILE }}" > .env
            echo "✓ .env erstellt"
            
            # Social Media Credentials (.env.social) erstellen
            # WICHTIG: Datei wird IMMER erstellt (auch leer), da docker-compose sie benötigt
            > .env.social
            if [ -n "${{ secrets.INSTAGRAM_SECRET }}" ]; then
              echo "${{ secrets.INSTAGRAM_SECRET }}" >> .env.social
              echo "" >> .env.social
            fi
            if [ -n "${{ secrets.TIKTOK_SECRET }}" ]; then
              echo "${{ secrets.TIKTOK_SECRET }}" >> .env.social
            fi
            echo "✓ .env.social erstellt"
            
            # Berechtigungen setzen
            chmod 600 .env .env.social
            
            echo "✓ Alle .env Dateien wurden aus GitHub Secrets geladen"

      # 5. Verzeichnisse für persistente Daten erstellen
      - name: Create data directories
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Erstelle Daten-Verzeichnisse ==="
            cd /lib
            
            # Verzeichnisse erstellen falls nicht vorhanden
            mkdir -p data
            mkdir -p static/uploads
            
            echo "✓ Verzeichnisse erstellt (Datenbanken werden vom Container initialisiert)"

      # 6. Docker Container neu bauen und starten
      - name: Build and start Docker containers
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Starte Docker Container ==="
            cd /lib
            
            # Container neu bauen und starten
            docker compose up -d --build --force-recreate --remove-orphans
            
            # Warte kurz auf Container-Start
            sleep 5
            
            # Prüfe ob Container laufen
            RUNNING_CONTAINERS=$(docker compose ps --services --filter status=running | wc -l)
            if [ "$RUNNING_CONTAINERS" -ge 2 ]; then
              echo "✓ Docker Container laufen ($RUNNING_CONTAINERS Services aktiv)"
            else
              echo "⚠ Warnung: Nicht alle Container laufen (nur $RUNNING_CONTAINERS von 2)"
              docker compose ps
              docker compose logs --tail=50
              exit 1
            fi
            
            # Alte, ungenutzte Docker Images entfernen
            docker image prune -f
            
            echo "✓ Deployment erfolgreich abgeschlossen"
