name: Server Diagnostics

on:
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Attempt automatic fixes for detected issues'
        type: boolean
        default: false
      target_service:
        description: 'Service to diagnose'
        type: choice
        default: 'all'
        options:
          - all
          - linktree_app
          - immocalc
          - rigpilot
          - cosmic-survivor
          - minecraft-web

jobs:
  diagnose:
    name: Run Diagnostics
    runs-on: ubuntu-latest
    permissions: {}
    
    steps:
      - name: Checkout repository (for Caddyfile reference)
        uses: actions/checkout@v4

      - name: Run Diagnostics
        uses: appleboy/ssh-action@v1.0.3
        env:
          AUTO_FIX: ${{ inputs.auto_fix }}
          TARGET_SERVICE: ${{ inputs.target_service }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: AUTO_FIX,TARGET_SERVICE
          command_timeout: 10m
          script: |
            set -uo pipefail
            
            # ==========================================
            # Configuration
            # ==========================================
            
            # Service configuration: container_name -> internal_port,domain,deploy_dir
            declare -A SERVICE_CONFIG
            SERVICE_CONFIG["linktree_app"]="8000,festas-builds.com,/home/deploy/link-in-bio"
            SERVICE_CONFIG["immocalc"]="3000,immocalc.festas-builds.com,/home/deploy/immocalc"
            SERVICE_CONFIG["rigpilot"]="3000,rigpilot.festas-builds.com,/home/deploy/rigpilot"
            SERVICE_CONFIG["cosmic-survivor"]="80,cs.festas-builds.com,/home/deploy/cosmic-survivor"
            SERVICE_CONFIG["minecraft-web"]="80,mc.festas-builds.com,/home/deploy/minecraft-server"
            
            # Required domains that must be present in Caddyfile
            REQUIRED_DOMAINS=(
              "festas-builds.com"
              "admin.festas-builds.com"
              "rigpilot.festas-builds.com"
              "immocalc.festas-builds.com"
              "mc.festas-builds.com"
              "cs.festas-builds.com"
            )
            
            # Track issues and warnings
            ISSUES=()
            WARNINGS=()
            
            add_issue() {
              ISSUES+=("$1")
            }
            
            add_warning() {
              WARNINGS+=("$1")
            }
            
            # Get service config values
            get_port() {
              echo "${SERVICE_CONFIG[$1]}" | cut -d',' -f1
            }
            
            get_domain() {
              echo "${SERVICE_CONFIG[$1]}" | cut -d',' -f2
            }
            
            get_deploy_dir() {
              echo "${SERVICE_CONFIG[$1]}" | cut -d',' -f3
            }
            
            # Check if docker compose file exists in a directory
            has_compose_file() {
              local dir="$1"
              [[ -d "$dir" ]] && [[ -f "${dir}/docker-compose.yml" || -f "${dir}/docker-compose.yaml" || -f "${dir}/compose.yml" || -f "${dir}/compose.yaml" ]]
            }
            
            # Check if Caddy container is running
            is_caddy_running() {
              docker ps --format '{{.Names}}' | grep -q '^caddy_server$'
            }
            
            # Filter services based on target
            get_target_services() {
              if [[ "${TARGET_SERVICE}" == "all" ]]; then
                echo "${!SERVICE_CONFIG[@]}"
              else
                echo "${TARGET_SERVICE}"
              fi
            }
            
            echo "=========================================="
            echo "üîç Server Diagnostics Report"
            echo "=========================================="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Target: ${TARGET_SERVICE}"
            echo "Auto-fix: ${AUTO_FIX}"
            echo ""
            
            # ==========================================
            # Step 1: Diagnostic Checks
            # ==========================================
            
            echo "=========================================="
            echo "üìä 1. Container Status Overview"
            echo "=========================================="
            echo ""
            echo "All running containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || {
              add_issue "Docker daemon may not be running"
              echo "‚ùå Failed to list containers"
            }
            echo ""
            
            echo "Caddy container status:"
            if docker ps --format '{{.Names}}' | grep -q '^caddy_server$'; then
              CADDY_STATUS=$(docker inspect --format '{{.State.Status}}' caddy_server 2>/dev/null || echo "unknown")
              echo "‚úÖ caddy_server is running (status: ${CADDY_STATUS})"
            else
              add_issue "Caddy container (caddy_server) is not running"
              echo "‚ùå caddy_server is NOT running"
            fi
            echo ""
            
            echo "=========================================="
            echo "üåê 2. caddy-network Inspection"
            echo "=========================================="
            echo ""
            
            if docker network inspect caddy-network >/dev/null 2>&1; then
              echo "‚úÖ caddy-network exists"
              echo ""
              echo "Connected containers:"
              docker network inspect caddy-network --format '{{range .Containers}}  - {{.Name}}{{println}}{{end}}' 2>/dev/null || echo "  (none)"
              
              CONNECTED_CONTAINERS=$(docker network inspect caddy-network --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null || echo "")
              
              for service in $(get_target_services); do
                if echo "$CONNECTED_CONTAINERS" | grep -qw "$service"; then
                  echo "‚úÖ ${service} is connected to caddy-network"
                else
                  if docker ps -a --format '{{.Names}}' | grep -q "^${service}$"; then
                    add_warning "${service} exists but is not connected to caddy-network"
                    echo "‚ö†Ô∏è  ${service} exists but is NOT connected to caddy-network"
                  else
                    add_warning "${service} container does not exist"
                    echo "‚ö†Ô∏è  ${service} container does not exist"
                  fi
                fi
              done
            else
              add_issue "caddy-network does not exist"
              echo "‚ùå caddy-network does NOT exist"
            fi
            echo ""
            
            echo "=========================================="
            echo "üîó 3. Internal Connectivity Tests"
            echo "=========================================="
            echo ""
            echo "Testing if Caddy can reach each service..."
            echo ""
            
            if is_caddy_running; then
              for service in $(get_target_services); do
                port=$(get_port "$service")
                echo "Testing ${service}:${port}..."
                
                # Try wget first (available in Caddy container), then curl as fallback
                if docker exec caddy_server wget -q --spider --timeout=5 "http://${service}:${port}/" 2>/dev/null; then
                  echo "‚úÖ ${service}:${port} is reachable from Caddy"
                elif docker exec caddy_server curl -sf --connect-timeout 5 "http://${service}:${port}/" >/dev/null 2>&1; then
                  echo "‚úÖ ${service}:${port} is reachable from Caddy (via curl)"
                else
                  add_issue "Cannot reach ${service}:${port} from Caddy container"
                  echo "‚ùå ${service}:${port} is NOT reachable from Caddy"
                fi
              done
            else
              add_issue "Caddy container not running - cannot test internal connectivity"
              echo "‚ùå Caddy container is not running - skipping connectivity tests"
            fi
            echo ""
            
            echo "=========================================="
            echo "üìù 4. Caddy Configuration"
            echo "=========================================="
            echo ""
            
            CADDY_CONFIG_PATH=""
            for path in "/srv/link-in-bio/Caddyfile" "/home/deploy/link-in-bio/Caddyfile"; do
              if [[ -f "$path" ]]; then
                CADDY_CONFIG_PATH="$path"
                break
              fi
            done
            
            if [[ -n "$CADDY_CONFIG_PATH" ]]; then
              echo "Caddyfile location: ${CADDY_CONFIG_PATH}"
              echo "---"
              cat "${CADDY_CONFIG_PATH}"
              echo "---"
            else
              add_warning "Caddyfile not found in expected locations"
              echo "‚ö†Ô∏è  Caddyfile not found"
            fi
            echo ""
            
            echo "=========================================="
            echo "üì¶ 4b. Active Caddyfile from Container"
            echo "=========================================="
            echo ""
            
            if is_caddy_running; then
              echo "Reading active Caddyfile from Caddy container..."
              echo "---"
              ACTIVE_CADDYFILE=$(docker exec caddy_server cat /etc/caddy/Caddyfile 2>&1 || echo "Failed to read Caddyfile from container")
              echo "$ACTIVE_CADDYFILE"
              echo "---"
            else
              add_warning "Caddy container not running - cannot read active Caddyfile"
              echo "‚ö†Ô∏è  Cannot read active Caddyfile - Caddy container is not running"
            fi
            echo ""
            
            echo "=========================================="
            echo "üîç 4c. Caddyfile Sync Check"
            echo "=========================================="
            echo ""
            
            CADDYFILE_MISSING_DOMAINS=()
            
            if is_caddy_running; then
              echo "Checking if all required domains are configured in the active Caddyfile..."
              for domain in "${REQUIRED_DOMAINS[@]}"; do
                # Check if the domain is present in the active Caddyfile (look for "domain {" pattern)
                if echo "$ACTIVE_CADDYFILE" | grep -qE "^[[:space:]]*${domain}[[:space:]]*\{"; then
                  echo "‚úÖ ${domain} is configured"
                else
                  add_issue "Caddyfile is missing entry for ${domain} - run deploy workflow to sync"
                  CADDYFILE_MISSING_DOMAINS+=("$domain")
                  echo "‚ùå ${domain} is NOT configured in Caddyfile"
                fi
              done
            else
              echo "‚ö†Ô∏è  Caddy container not running - cannot check domain configuration"
            fi
            echo ""
            
            echo "=========================================="
            echo "‚úîÔ∏è  5. Caddy Config Validation"
            echo "=========================================="
            echo ""
            
            if docker exec caddy_server caddy validate --config /etc/caddy/Caddyfile 2>&1; then
              echo "‚úÖ Caddy configuration is valid"
            else
              add_issue "Caddy configuration validation failed"
              echo "‚ùå Caddy configuration is INVALID"
            fi
            echo ""
            
            echo "=========================================="
            echo "üìã 6. Caddy Logs Analysis"
            echo "=========================================="
            echo ""
            
            echo "Recent Caddy logs (last 50 lines):"
            CADDY_LOGS=$(docker logs caddy_server --tail 50 2>&1 || echo "Failed to retrieve logs")
            echo "$CADDY_LOGS"
            echo ""
            
            # Check for common issues in logs
            echo "Checking for issues in logs..."
            if echo "$CADDY_LOGS" | grep -qi "error"; then
              add_warning "Errors found in Caddy logs"
              echo "‚ö†Ô∏è  Errors detected in Caddy logs"
            else
              echo "‚úÖ No errors found in recent Caddy logs"
            fi
            
            if echo "$CADDY_LOGS" | grep -qi "tls\|certificate\|acme"; then
              if echo "$CADDY_LOGS" | grep -qi "failed\|error\|unable"; then
                add_warning "TLS/certificate issues detected in Caddy logs"
                echo "‚ö†Ô∏è  TLS/certificate issues detected"
              else
                echo "‚úÖ TLS mentions found but no issues detected"
              fi
            fi
            echo ""
            
            echo "=========================================="
            echo "üê≥ 6b. Docker Image Name Validation"
            echo "=========================================="
            echo ""
            
            echo "Checking docker-compose.yml files for image naming issues..."
            DOCKER_COMPOSE_ISSUES=()
            
            for service in $(get_target_services); do
              deploy_dir=$(get_deploy_dir "$service")
              for compose_file in "docker-compose.yml" "docker-compose.yaml" "compose.yml" "compose.yaml"; do
                if [[ -f "${deploy_dir}/${compose_file}" ]]; then
                  echo "Checking ${deploy_dir}/${compose_file}..."
                  
                  # Check for uppercase letters in image names
                  UPPERCASE_IMAGES=$(grep -E '^\s*image:' "${deploy_dir}/${compose_file}" 2>/dev/null | grep -E '[A-Z]' || true)
                  if [[ -n "$UPPERCASE_IMAGES" ]]; then
                    add_issue "Docker image name contains uppercase in ${deploy_dir}/${compose_file} - fix docker-compose.yml"
                    DOCKER_COMPOSE_ISSUES+=("${deploy_dir}/${compose_file}: Uppercase in image name")
                    echo "‚ùå Found uppercase in image names:"
                    echo "$UPPERCASE_IMAGES"
                  else
                    echo "‚úÖ No uppercase letters in image names"
                  fi
                  
                  # Check for invalid image references (basic check)
                  IMAGES=$(grep -E '^\s*image:' "${deploy_dir}/${compose_file}" 2>/dev/null | sed 's/.*image:[[:space:]]*//' | tr -d '"' | tr -d "'" || true)
                  for image in $IMAGES; do
                    # Skip caddy:latest and other known good images
                    if [[ "$image" == "caddy:latest" ]] || [[ "$image" == "caddy:"* ]]; then
                      continue
                    fi
                    # Check if image reference looks valid (has tag or digest)
                    if [[ ! "$image" =~ : ]] && [[ ! "$image" =~ @ ]]; then
                      add_warning "Image '${image}' in ${deploy_dir}/${compose_file} has no tag or digest - consider using explicit versioning"
                      echo "‚ö†Ô∏è  Image '${image}' has no explicit tag"
                    fi
                  done
                  
                  break  # Only check first compose file found
                fi
              done
            done
            
            if [[ ${#DOCKER_COMPOSE_ISSUES[@]} -eq 0 ]]; then
              echo "‚úÖ No Docker image naming issues found"
            fi
            echo ""
            
            echo "=========================================="
            echo "üè• 7. Service Health Checks"
            echo "=========================================="
            echo ""
            
            for service in $(get_target_services); do
              echo "Checking ${service}..."
              
              if docker ps -a --format '{{.Names}}' | grep -q "^${service}$"; then
                STATUS=$(docker inspect --format '{{.State.Status}}' "$service" 2>/dev/null || echo "unknown")
                HEALTH=$(docker inspect --format '{{if .State.Health}}{{.State.Health.Status}}{{else}}no healthcheck{{end}}' "$service" 2>/dev/null || echo "unknown")
                
                if [[ "$STATUS" == "running" ]]; then
                  echo "‚úÖ ${service}: running (health: ${HEALTH})"
                  if [[ "$HEALTH" == "unhealthy" ]]; then
                    add_warning "${service} is running but unhealthy"
                  fi
                else
                  add_issue "${service} is not running (status: ${STATUS})"
                  echo "‚ùå ${service}: ${STATUS} (not running)"
                  
                  # When a container fails to start, check for image issues
                  deploy_dir=$(get_deploy_dir "$service")
                  if [[ -f "${deploy_dir}/docker-compose.yml" ]]; then
                    echo "  Checking docker-compose.yml for potential issues..."
                    COMPOSE_IMAGES=$(grep -E '^\s*image:' "${deploy_dir}/docker-compose.yml" 2>/dev/null || true)
                    if [[ -n "$COMPOSE_IMAGES" ]]; then
                      echo "  Images configured:"
                      echo "$COMPOSE_IMAGES" | sed 's/^/    /'
                      if echo "$COMPOSE_IMAGES" | grep -qE '[A-Z]'; then
                        echo "  üí° Suggestion: Docker image name contains uppercase - fix docker-compose.yml"
                      fi
                    fi
                  fi
                fi
              else
                add_warning "${service} container does not exist"
                echo "‚ö†Ô∏è  ${service}: container does not exist"
              fi
            done
            echo ""
            
            echo "=========================================="
            echo "üåç 8. DNS Resolution"
            echo "=========================================="
            echo ""
            
            for service in $(get_target_services); do
              domain=$(get_domain "$service")
              echo "Checking DNS for ${domain}..."
              
              RESOLVED_IP=$(dig +short "$domain" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
              if [[ -n "$RESOLVED_IP" ]]; then
                echo "‚úÖ ${domain} resolves to ${RESOLVED_IP}"
              else
                add_warning "DNS resolution failed for ${domain}"
                echo "‚ö†Ô∏è  ${domain} - DNS resolution failed"
              fi
            done
            echo ""
            
            echo "=========================================="
            echo "üåê 8b. External Connectivity Tests"
            echo "=========================================="
            echo ""
            
            echo "Testing if domains are accessible from the internet (via HTTPS)..."
            EXTERNAL_CONNECTIVITY_ISSUES=()
            
            for service in $(get_target_services); do
              domain=$(get_domain "$service")
              echo "Testing https://${domain}..."
              
              # Test external HTTPS connectivity with timeout
              if curl -sf --connect-timeout 10 "https://${domain}" > /dev/null 2>&1; then
                echo "‚úÖ https://${domain} is accessible from the internet"
              else
                # Try with -k to ignore certificate issues (to distinguish between cert vs connectivity issues)
                if curl -sfk --connect-timeout 10 "https://${domain}" > /dev/null 2>&1; then
                  add_warning "https://${domain} is accessible but has SSL certificate issues"
                  EXTERNAL_CONNECTIVITY_ISSUES+=("${domain}: SSL certificate issue")
                  echo "‚ö†Ô∏è  https://${domain} is accessible but has SSL certificate issues"
                else
                  add_issue "https://${domain} is NOT accessible from the internet"
                  EXTERNAL_CONNECTIVITY_ISSUES+=("${domain}: Not accessible")
                  echo "‚ùå https://${domain} is NOT accessible from the internet"
                fi
              fi
            done
            
            # Also test the admin subdomain explicitly if not already covered
            echo ""
            echo "Testing admin.festas-builds.com..."
            if curl -sf --connect-timeout 10 "https://admin.festas-builds.com" > /dev/null 2>&1; then
              echo "‚úÖ https://admin.festas-builds.com is accessible from the internet"
            else
              if curl -sfk --connect-timeout 10 "https://admin.festas-builds.com" > /dev/null 2>&1; then
                add_warning "https://admin.festas-builds.com is accessible but has SSL certificate issues"
                echo "‚ö†Ô∏è  https://admin.festas-builds.com is accessible but has SSL certificate issues"
              else
                add_issue "https://admin.festas-builds.com is NOT accessible from the internet"
                echo "‚ùå https://admin.festas-builds.com is NOT accessible from the internet"
              fi
            fi
            echo ""
            
            echo "=========================================="
            echo "üîí 9. SSL Certificate Status"
            echo "=========================================="
            echo ""
            
            # Check Caddy's certificate storage
            echo "Caddy certificate storage:"
            if docker exec caddy_server ls -la /data/caddy/certificates/ 2>/dev/null; then
              echo ""
              
              for service in $(get_target_services); do
                domain=$(get_domain "$service")
                echo "Checking certificate for ${domain}..."
                
                CERT_PATH=$(docker exec caddy_server find /data/caddy/certificates -name "${domain}*" -type d 2>/dev/null | head -1)
                if [[ -n "$CERT_PATH" ]]; then
                  echo "‚úÖ Certificate found for ${domain}"
                  docker exec caddy_server ls -la "$CERT_PATH" 2>/dev/null || true
                else
                  add_warning "No certificate found for ${domain}"
                  echo "‚ö†Ô∏è  No certificate found for ${domain}"
                fi
              done
            else
              add_warning "Could not access Caddy certificate storage"
              echo "‚ö†Ô∏è  Could not access certificate storage"
            fi
            echo ""
            
            echo "=========================================="
            echo "üíæ 10. Disk and Resource Usage"
            echo "=========================================="
            echo ""
            
            echo "Docker disk usage:"
            docker system df
            echo ""
            
            echo "Deployment directory sizes:"
            for service in $(get_target_services); do
              deploy_dir=$(get_deploy_dir "$service")
              if [[ -d "$deploy_dir" ]]; then
                SIZE=$(du -sh "$deploy_dir" 2>/dev/null | cut -f1)
                echo "  ${deploy_dir}: ${SIZE}"
              else
                echo "  ${deploy_dir}: directory not found"
              fi
            done
            echo ""
            
            # ==========================================
            # Summary
            # ==========================================
            
            echo "=========================================="
            echo "üìä Diagnostic Summary"
            echo "=========================================="
            echo ""
            echo "Critical Issues: ${#ISSUES[@]}"
            echo "Warnings: ${#WARNINGS[@]}"
            echo ""
            
            if [[ ${#ISSUES[@]} -gt 0 ]]; then
              echo "‚ùå Critical Issues:"
              for issue in "${ISSUES[@]}"; do
                echo "  - $issue"
              done
              echo ""
            fi
            
            if [[ ${#WARNINGS[@]} -gt 0 ]]; then
              echo "‚ö†Ô∏è  Warnings:"
              for warning in "${WARNINGS[@]}"; do
                echo "  - $warning"
              done
              echo ""
            fi
            
            if [[ ${#ISSUES[@]} -eq 0 && ${#WARNINGS[@]} -eq 0 ]]; then
              echo "‚úÖ All checks passed! No issues detected."
            fi
            echo ""
            
            # ==========================================
            # Step 2: Auto-Fix (if enabled)
            # ==========================================
            
            if [[ "${AUTO_FIX}" == "true" && (${#ISSUES[@]} -gt 0 || ${#WARNINGS[@]} -gt 0) ]]; then
              echo "=========================================="
              echo "üîß Auto-Fix Mode Enabled"
              echo "=========================================="
              echo ""
              
              FIXES_APPLIED=0
              
              # Fix 1: Create caddy-network if it doesn't exist
              echo "Fix 1: Checking caddy-network..."
              if ! docker network inspect caddy-network >/dev/null 2>&1; then
                echo "Creating caddy-network..."
                if docker network create caddy-network; then
                  echo "‚úÖ Created caddy-network"
                  ((FIXES_APPLIED++))
                else
                  echo "‚ùå Failed to create caddy-network"
                fi
              else
                echo "‚úÖ caddy-network already exists"
              fi
              echo ""
              
              # Fix 2: Connect disconnected containers to the network
              echo "Fix 2: Connecting containers to caddy-network..."
              CONNECTED_CONTAINERS=$(docker network inspect caddy-network --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null || echo "")
              
              for service in $(get_target_services); do
                if docker ps --format '{{.Names}}' | grep -q "^${service}$"; then
                  if ! echo "$CONNECTED_CONTAINERS" | grep -qw "$service"; then
                    echo "Connecting ${service} to caddy-network..."
                    if docker network connect caddy-network "$service" 2>/dev/null; then
                      echo "‚úÖ Connected ${service} to caddy-network"
                      ((FIXES_APPLIED++))
                    else
                      echo "‚ùå Failed to connect ${service} to caddy-network"
                    fi
                  else
                    echo "‚úÖ ${service} already connected"
                  fi
                fi
              done
              echo ""
              
              # Fix 3: Start stopped containers
              echo "Fix 3: Starting stopped containers..."
              for service in $(get_target_services); do
                if docker ps -a --format '{{.Names}}' | grep -q "^${service}$"; then
                  STATUS=$(docker inspect --format '{{.State.Status}}' "$service" 2>/dev/null || echo "unknown")
                  if [[ "$STATUS" != "running" ]]; then
                    deploy_dir=$(get_deploy_dir "$service")
                    echo "Starting ${service} via docker compose in ${deploy_dir}..."
                    if has_compose_file "$deploy_dir"; then
                      if (cd "$deploy_dir" && docker compose up -d); then
                        echo "‚úÖ Started services in ${deploy_dir}"
                        ((FIXES_APPLIED++))
                      else
                        echo "‚ùå Failed to start services in ${deploy_dir}"
                      fi
                    else
                      echo "‚ö†Ô∏è  No docker compose file found in ${deploy_dir}, trying docker start..."
                      if docker start "$service"; then
                        echo "‚úÖ Started ${service}"
                        ((FIXES_APPLIED++))
                      else
                        echo "‚ùå Failed to start ${service}"
                      fi
                    fi
                  else
                    echo "‚úÖ ${service} is already running"
                  fi
                else
                  deploy_dir=$(get_deploy_dir "$service")
                  if has_compose_file "$deploy_dir"; then
                    echo "Container ${service} doesn't exist, trying to create via docker compose in ${deploy_dir}..."
                    if (cd "$deploy_dir" && docker compose up -d); then
                      echo "‚úÖ Created and started services in ${deploy_dir}"
                      ((FIXES_APPLIED++))
                    else
                      echo "‚ùå Failed to create services in ${deploy_dir}"
                    fi
                  else
                    echo "‚ö†Ô∏è  Deploy directory ${deploy_dir} not found or no compose file, cannot start ${service}"
                  fi
                fi
              done
              echo ""
              
              # Fix 4: Sync Caddyfile if domains are missing
              echo "Fix 4: Checking Caddyfile sync..."
              if [[ ${#CADDYFILE_MISSING_DOMAINS[@]} -gt 0 ]]; then
                echo "Caddyfile is missing ${#CADDYFILE_MISSING_DOMAINS[@]} domain(s). Generating complete Caddyfile..."
                
                CADDY_DEPLOY_PATH="/srv/link-in-bio/Caddyfile"
                if [[ ! -f "$CADDY_DEPLOY_PATH" ]]; then
                  CADDY_DEPLOY_PATH="/home/deploy/link-in-bio/Caddyfile"
                fi
                
                # Generate complete Caddyfile with all required domains
                cat > "${CADDY_DEPLOY_PATH}" << 'CADDYFILE_EOF'
            # Main domain - public-facing Link-in-Bio site
            festas-builds.com {
                tls eric@festas-builds.com
                reverse_proxy web:8000
            }
            
            # Admin subdomain - administrative interface
            admin.festas-builds.com {
                tls eric@festas-builds.com
                reverse_proxy web:8000
            }
            
            # RigPilot subdomain - PC Builder application
            rigpilot.festas-builds.com {
                tls eric@festas-builds.com
                encode gzip zstd
                @static path /_next/static/*
                header @static Cache-Control "public, max-age=31536000, immutable"
                reverse_proxy rigpilot:3000
            }
            
            # ImmoCalc subdomain - Immobilien Investment Calculator
            immocalc.festas-builds.com {
                tls eric@festas-builds.com
                encode gzip zstd
                @static path /_next/static/*
                header @static Cache-Control "public, max-age=31536000, immutable"
                reverse_proxy immocalc:3000
            }
            
            # Minecraft Server Website
            mc.festas-builds.com {
                tls eric@festas-builds.com
                encode gzip zstd
                @static path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
                header @static Cache-Control "public, max-age=31536000, immutable"
                reverse_proxy minecraft-web:80
            }
            
            # Cosmic Survivor Game
            cs.festas-builds.com {
                tls eric@festas-builds.com
                encode gzip zstd
                @static path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.mp3 *.ogg *.wav
                header @static Cache-Control "public, max-age=31536000, immutable"
                reverse_proxy cosmic-survivor:80
            }
            CADDYFILE_EOF
                
                # Strip leading whitespace from heredoc
                sed -i 's/^            //' "${CADDY_DEPLOY_PATH}" || true
                
                echo "‚úÖ Caddyfile updated with all required domains"
                echo ""
                echo "New Caddyfile contents:"
                cat "${CADDY_DEPLOY_PATH}"
                echo ""
                
                # Copy to Caddy container and reload
                echo "Copying updated Caddyfile to Caddy container..."
                if docker cp "${CADDY_DEPLOY_PATH}" caddy_server:/etc/caddy/Caddyfile; then
                  echo "‚úÖ Caddyfile copied to container"
                  ((FIXES_APPLIED++))
                  
                  # Validate and reload
                  echo "Validating and reloading Caddy configuration..."
                  if docker exec caddy_server caddy validate --config /etc/caddy/Caddyfile 2>&1; then
                    if docker exec caddy_server caddy reload --config /etc/caddy/Caddyfile 2>&1; then
                      echo "‚úÖ Caddy configuration reloaded successfully"
                      ((FIXES_APPLIED++))
                    else
                      echo "‚ö†Ô∏è  Caddy reload failed after Caddyfile update"
                    fi
                  else
                    echo "‚ùå Updated Caddyfile validation failed - reverting may be needed"
                  fi
                else
                  echo "‚ùå Failed to copy Caddyfile to container"
                fi
              else
                echo "‚úÖ Caddyfile has all required domains"
              fi
              echo ""
              
              # Fix 5: Reload Caddy configuration
              echo "Fix 5: Reloading Caddy configuration..."
              if docker exec caddy_server caddy reload --config /etc/caddy/Caddyfile 2>&1; then
                echo "‚úÖ Caddy configuration reloaded"
                ((FIXES_APPLIED++))
              else
                echo "‚ö†Ô∏è  Caddy reload failed, attempting restart..."
                if docker restart caddy_server; then
                  echo "‚úÖ Caddy container restarted"
                  ((FIXES_APPLIED++))
                else
                  echo "‚ùå Failed to restart Caddy"
                fi
              fi
              echo ""
              
              # Fix 6: Restart unhealthy containers
              echo "Fix 6: Checking for unhealthy containers..."
              for service in $(get_target_services); do
                if docker ps --format '{{.Names}}' | grep -q "^${service}$"; then
                  HEALTH=$(docker inspect --format '{{if .State.Health}}{{.State.Health.Status}}{{else}}no healthcheck{{end}}' "$service" 2>/dev/null || echo "unknown")
                  if [[ "$HEALTH" == "unhealthy" ]]; then
                    echo "Restarting unhealthy container ${service}..."
                    if docker restart "$service"; then
                      echo "‚úÖ Restarted ${service}"
                      ((FIXES_APPLIED++))
                    else
                      echo "‚ùå Failed to restart ${service}"
                    fi
                  fi
                fi
              done
              echo ""
              
              # Post-fix verification
              echo "=========================================="
              echo "üîç Post-Fix Verification"
              echo "=========================================="
              echo ""
              
              echo "Waiting 10 seconds for services to stabilize..."
              sleep 10
              
              echo "Verifying connectivity..."
              VERIFICATION_PASSED=true
              
              if is_caddy_running; then
                for service in $(get_target_services); do
                  port=$(get_port "$service")
                  if docker exec caddy_server wget -q --spider --timeout=5 "http://${service}:${port}/" 2>/dev/null || \
                     docker exec caddy_server curl -sf --connect-timeout 5 "http://${service}:${port}/" >/dev/null 2>&1; then
                    echo "‚úÖ ${service}:${port} is now reachable"
                  else
                    echo "‚ùå ${service}:${port} is still NOT reachable"
                    VERIFICATION_PASSED=false
                  fi
                done
              else
                echo "‚ùå Caddy container is not running - cannot verify connectivity"
                VERIFICATION_PASSED=false
              fi
              echo ""
              
              echo "=========================================="
              echo "üìä Auto-Fix Summary"
              echo "=========================================="
              echo ""
              echo "Fixes applied: ${FIXES_APPLIED}"
              if [[ "$VERIFICATION_PASSED" == "true" ]]; then
                echo "‚úÖ All services are now reachable"
              else
                echo "‚ö†Ô∏è  Some services are still not reachable - manual intervention may be required"
              fi
              echo ""
            elif [[ "${AUTO_FIX}" == "true" ]]; then
              echo "=========================================="
              echo "‚ÑπÔ∏è  Auto-Fix Skipped"
              echo "=========================================="
              echo "No issues or warnings detected - nothing to fix."
              echo ""
            fi
            
            echo "=========================================="
            echo "üèÅ Diagnostics Complete"
            echo "=========================================="
