name: Test Social Media Fetch

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        default: 'both'
        type: choice
        options:
          - instagram
          - tiktok
          - both
      project_path:
        description: 'Path to project on server'
        required: false
        default: '/srv/link-in-bio'
        type: string

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Check SSH secrets
        run: |
          echo "=========================================="
          echo "üîê Validating Required Secrets"
          echo "=========================================="
          
          MISSING_SECRETS=false
          
          if [ -z "${{ secrets.HOST }}" ]; then
            echo "‚ùå Missing secret: HOST (server IP address)"
            MISSING_SECRETS=true
          else
            echo "‚úÖ HOST is configured"
          fi
          
          if [ -z "${{ secrets.USERNAME }}" ]; then
            echo "‚ùå Missing secret: USERNAME (SSH username)"
            MISSING_SECRETS=true
          else
            echo "‚úÖ USERNAME is configured"
          fi
          
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Missing secret: SSH_PRIVATE_KEY"
            MISSING_SECRETS=true
          else
            echo "‚úÖ SSH_PRIVATE_KEY is configured"
          fi
          
          echo ""
          echo "Checking social media secrets for platform: ${{ inputs.platform }}"
          echo ""
          
          if [ "${{ inputs.platform }}" = "instagram" ] || [ "${{ inputs.platform }}" = "both" ]; then
            if [ -z "${{ secrets.INSTAGRAM_SECRET }}" ]; then
              echo "‚ö†Ô∏è INSTAGRAM_SECRET not configured (Instagram tests may fail)"
              echo ""
              echo "üí° To configure Instagram:"
              echo "   1. Go to Repository ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
              echo "   2. Add 'INSTAGRAM_SECRET' with your credentials"
              echo "   3. See docs/SOCIAL_TOKENS.md for token setup"
            else
              echo "‚úÖ INSTAGRAM_SECRET is configured"
            fi
          fi
          
          if [ "${{ inputs.platform }}" = "tiktok" ] || [ "${{ inputs.platform }}" = "both" ]; then
            if [ -z "${{ secrets.TIKTOK_SECRET }}" ]; then
              echo "‚ö†Ô∏è TIKTOK_SECRET not configured (TikTok tests may fail)"
              echo ""
              echo "üí° To configure TikTok:"
              echo "   1. Go to Repository ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
              echo "   2. Add 'TIKTOK_SECRET' with your credentials"
              echo "   3. See docs/SOCIAL_TOKENS.md for token setup"
            else
              echo "‚úÖ TIKTOK_SECRET is configured"
            fi
          fi
          
          echo ""
          
          if [ "$MISSING_SECRETS" = "true" ]; then
            echo "=========================================="
            echo "‚ùå Required secrets are missing!"
            echo "=========================================="
            echo ""
            echo "üìö Setup Guide: docs/SOCIAL_TOKENS.md"
            echo ""
            echo "Required secrets for SSH connection:"
            echo "  ‚Ä¢ HOST - Server IP or hostname"
            echo "  ‚Ä¢ USERNAME - SSH username (e.g., deploy)"
            echo "  ‚Ä¢ SSH_PRIVATE_KEY - SSH private key for authentication"
            exit 1
          fi
          
          echo "=========================================="
          echo "‚úÖ All required secrets are configured"
          echo "=========================================="

  test-fetch:
    name: Test Social Media Stats Fetching
    runs-on: ubuntu-latest
    needs: validate-secrets
    
    permissions: {}
    
    steps:
      - name: Display test configuration
        run: |
          echo "=========================================="
          echo "üß™ Social Media Fetch Test Configuration"
          echo "=========================================="
          echo "Timestamp:     $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Platform:      ${{ inputs.platform }}"
          echo "Project Path:  ${{ inputs.project_path }}"
          echo "=========================================="

      - name: Test Social Media Fetching via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          INSTAGRAM_SECRET: ${{ secrets.INSTAGRAM_SECRET }}
          TIKTOK_SECRET: ${{ secrets.TIKTOK_SECRET }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: INSTAGRAM_SECRET,TIKTOK_SECRET
          script: |
            set -euo pipefail
            
            echo "=========================================="
            echo "üß™ Social Media Stats Fetch Test"
            echo "=========================================="
            echo "‚è∞ Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "üìç Platform: ${{ inputs.platform }}"
            echo "üìÇ Project Path: ${{ inputs.project_path }}"
            echo "=========================================="
            echo ""
            
            PROJECT_PATH="${{ inputs.project_path }}"
            
            # ==========================================
            # 1. Navigate to project directory
            # ==========================================
            echo "[1/6] üìÇ Navigating to project directory..."
            
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "‚ùå ERROR: Project directory does not exist: $PROJECT_PATH"
              echo ""
              echo "üí° Possible solutions:"
              echo "   1. Deploy the application first using the deploy workflow"
              echo "   2. Verify the project_path input is correct"
              echo "   3. Run: curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/deploy/bootstrap.sh | sudo bash"
              exit 1
            fi
            
            cd "$PROJECT_PATH"
            echo "‚úÖ Working directory: $(pwd)"
            echo ""
            
            # ==========================================
            # 2. Check Docker status
            # ==========================================
            echo "[2/6] üê≥ Checking Docker status..."
            
            if ! command -v docker &>/dev/null; then
              echo "‚ùå ERROR: Docker is not installed"
              echo "üí° Run: curl -fsSL https://get.docker.com | sh"
              exit 1
            fi
            
            if ! docker compose ps > /dev/null 2>&1; then
              echo "‚ùå ERROR: Docker Compose is not running or not available"
              echo "üí° Please ensure the application is deployed and Docker is running."
              exit 1
            fi
            
            # Check if the web service is running
            if ! docker compose ps --services --filter status=running 2>/dev/null | grep -q "^web$"; then
              echo "‚ùå ERROR: Web service is not running"
              echo ""
              echo "Current container status:"
              docker compose ps || true
              echo ""
              echo "üí° Run: docker compose up -d"
              exit 1
            fi
            
            echo "‚úÖ Web service is running"
            docker compose ps
            echo ""
            
            # ==========================================
            # 3. Create/update .env.social from secrets
            # ==========================================
            echo "[3/6] üîë Setting up credentials..."
            
            ENV_SOCIAL_FILE="${PROJECT_PATH}/.env.social"
            SECRETS_UPDATED=false
            
            # Create or update .env.social from GitHub Secrets
            if [ -n "${INSTAGRAM_SECRET:-}" ] || [ -n "${TIKTOK_SECRET:-}" ]; then
              echo "üìù Creating .env.social from GitHub Secrets..."
              
              {
                echo "# Auto-generated from GitHub Secrets"
                echo "# Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
                echo "# DO NOT EDIT - Changes will be overwritten by GitHub Actions"
                echo ""
                
                if [ -n "${INSTAGRAM_SECRET:-}" ]; then
                  echo "# Instagram credentials"
                  echo "${INSTAGRAM_SECRET}"
                  echo ""
                fi
                
                if [ -n "${TIKTOK_SECRET:-}" ]; then
                  echo "# TikTok credentials"
                  echo "${TIKTOK_SECRET}"
                  echo ""
                fi
              } > "$ENV_SOCIAL_FILE"
              
              chmod 644 "$ENV_SOCIAL_FILE"
              echo "‚úÖ .env.social created/updated from secrets"
              SECRETS_UPDATED=true
            elif [ ! -f "$ENV_SOCIAL_FILE" ]; then
              echo "‚ùå ERROR: .env.social is missing and no secrets are available"
              echo ""
              echo "üí° To fix this, configure GitHub Secrets:"
              echo "   1. Go to Repository ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
              echo "   2. Add 'INSTAGRAM_SECRET' for Instagram credentials"
              echo "   3. Add 'TIKTOK_SECRET' for TikTok credentials"
              echo ""
              echo "   See docs/SOCIAL_TOKENS.md for detailed setup instructions."
              exit 1
            else
              echo "‚úÖ Using existing .env.social file"
            fi
            
            # Validate credentials for requested platforms
            if [ "${{ inputs.platform }}" = "instagram" ] || [ "${{ inputs.platform }}" = "both" ]; then
              echo ""
              echo "üì± Checking Instagram credentials..."
              if grep -qE "^INSTAGRAM_ACCESS_TOKEN=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ INSTAGRAM_ACCESS_TOKEN is configured"
              else
                echo "  ‚ö†Ô∏è INSTAGRAM_ACCESS_TOKEN is missing or empty"
              fi
              
              if grep -q "INSTAGRAM_USERNAME=" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                INSTA_USER=$(grep "INSTAGRAM_USERNAME=" "$ENV_SOCIAL_FILE" | head -n1 | cut -d'=' -f2)
                echo "  ‚úÖ INSTAGRAM_USERNAME: @$INSTA_USER"
              else
                echo "  ‚ö†Ô∏è INSTAGRAM_USERNAME not found"
              fi
              
              if grep -qE "^INSTAGRAM_APP_ID=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ INSTAGRAM_APP_ID is configured"
              else
                echo "  ‚ö†Ô∏è INSTAGRAM_APP_ID not found (token refresh disabled)"
              fi
              
              if grep -qE "^INSTAGRAM_APP_SECRET=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ INSTAGRAM_APP_SECRET is configured"
              else
                echo "  ‚ö†Ô∏è INSTAGRAM_APP_SECRET not found (token refresh disabled)"
              fi
            fi
            
            if [ "${{ inputs.platform }}" = "tiktok" ] || [ "${{ inputs.platform }}" = "both" ]; then
              echo ""
              echo "üì± Checking TikTok credentials..."
              if grep -qE "^TIKTOK_ACCESS_TOKEN=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ TIKTOK_ACCESS_TOKEN is configured"
              else
                echo "  ‚ö†Ô∏è TIKTOK_ACCESS_TOKEN is missing or empty"
              fi
              
              if grep -qE "^TIKTOK_REFRESH_TOKEN=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ TIKTOK_REFRESH_TOKEN is configured"
              else
                echo "  ‚ö†Ô∏è TIKTOK_REFRESH_TOKEN not found (token refresh disabled)"
              fi
              
              if grep -qE "^TIKTOK_CLIENT_KEY=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ TIKTOK_CLIENT_KEY is configured"
              else
                echo "  ‚ö†Ô∏è TIKTOK_CLIENT_KEY not found (token refresh disabled)"
              fi
              
              if grep -qE "^TIKTOK_CLIENT_SECRET=.+" "$ENV_SOCIAL_FILE" 2>/dev/null; then
                echo "  ‚úÖ TIKTOK_CLIENT_SECRET is configured"
              else
                echo "  ‚ö†Ô∏è TIKTOK_CLIENT_SECRET not found (token refresh disabled)"
              fi
            fi
            
            echo ""
            
            # ==========================================
            # 4. Restart container if secrets were updated
            # ==========================================
            echo "[4/6] üîÑ Ensuring container has latest credentials..."
            
            if [ "$SECRETS_UPDATED" = "true" ]; then
              echo "Restarting web service to pick up new credentials..."
              docker compose restart web
              sleep 5
              
              # Verify service is healthy
              if docker compose ps --services --filter status=running 2>/dev/null | grep -q "^web$"; then
                echo "‚úÖ Web service restarted successfully"
              else
                echo "‚ö†Ô∏è Web service may still be starting..."
                sleep 10
              fi
            else
              echo "‚úÖ No credential updates, skipping restart"
            fi
            
            echo ""
            
            # ==========================================
            # 5. Run fetch scripts
            # ==========================================
            echo "[5/6] üöÄ Running fetch scripts..."
            echo ""
            
            INSTAGRAM_SUCCESS=false
            TIKTOK_SUCCESS=false
            INSTAGRAM_RAN=false
            TIKTOK_RAN=false
            
            # Run Instagram fetch if requested
            if [ "${{ inputs.platform }}" = "instagram" ] || [ "${{ inputs.platform }}" = "both" ]; then
              INSTAGRAM_RAN=true
              echo "=========================================="
              echo "üì∏ INSTAGRAM STATS FETCH"
              echo "=========================================="
              echo "‚è∞ Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo ""
              
              if docker compose exec -T web python fetch_instagram_stats.py 2>&1; then
                INSTAGRAM_SUCCESS=true
                echo ""
                echo "‚úÖ Instagram fetch completed successfully"
              else
                EXIT_CODE=$?
                echo ""
                echo "‚ùå Instagram fetch failed (exit code: $EXIT_CODE)"
                echo ""
                echo "üí° Common issues and solutions:"
                echo "   ‚Ä¢ 'No Instagram Business Account found':"
                echo "      - Ensure account is Business/Creator (not Personal)"
                echo "      - Link Instagram to a Facebook Page"
                echo "      - Verify App has 'instagram_basic' permission"
                echo "   ‚Ä¢ 'Token expired or invalid':"
                echo "      - Regenerate token in Meta Developer Portal"
                echo "      - Update INSTAGRAM_SECRET in GitHub Secrets"
              fi
              
              echo "‚è∞ Finished at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo "=========================================="
              echo ""
            fi
            
            # Run TikTok fetch if requested
            if [ "${{ inputs.platform }}" = "tiktok" ] || [ "${{ inputs.platform }}" = "both" ]; then
              TIKTOK_RAN=true
              echo "=========================================="
              echo "üéµ TIKTOK STATS FETCH"
              echo "=========================================="
              echo "‚è∞ Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo ""
              
              if docker compose exec -T web python fetch_tiktok_stats.py 2>&1; then
                TIKTOK_SUCCESS=true
                echo ""
                echo "‚úÖ TikTok fetch completed successfully"
              else
                EXIT_CODE=$?
                echo ""
                echo "‚ùå TikTok fetch failed (exit code: $EXIT_CODE)"
                echo ""
                echo "üí° Common issues and solutions:"
                echo "   ‚Ä¢ '401 Unauthorized':"
                echo "      - Access token expired (24h lifetime)"
                echo "      - Regenerate via TikTok Developer Portal"
                echo "   ‚Ä¢ 'Invalid client_key':"
                echo "      - Verify TIKTOK_CLIENT_KEY matches your app"
              fi
              
              echo "‚è∞ Finished at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              echo "=========================================="
              echo ""
            fi
            
            # ==========================================
            # 6. Summary
            # ==========================================
            echo "[6/6] üìä Test Summary"
            echo "=========================================="
            echo "‚è∞ Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            
            OVERALL_SUCCESS=true
            
            if [ "$INSTAGRAM_RAN" = "true" ]; then
              if [ "$INSTAGRAM_SUCCESS" = "true" ]; then
                echo "üì∏ Instagram: ‚úÖ SUCCESS"
              else
                echo "üì∏ Instagram: ‚ùå FAILED"
                OVERALL_SUCCESS=false
              fi
            else
              echo "üì∏ Instagram: ‚è≠Ô∏è SKIPPED"
            fi
            
            if [ "$TIKTOK_RAN" = "true" ]; then
              if [ "$TIKTOK_SUCCESS" = "true" ]; then
                echo "üéµ TikTok:    ‚úÖ SUCCESS"
              else
                echo "üéµ TikTok:    ‚ùå FAILED"
                OVERALL_SUCCESS=false
              fi
            else
              echo "üéµ TikTok:    ‚è≠Ô∏è SKIPPED"
            fi
            
            echo ""
            echo "=========================================="
            
            if [ "$OVERALL_SUCCESS" = "true" ]; then
              echo "üéâ All requested tests passed!"
              exit 0
            else
              echo "‚ö†Ô∏è Some tests failed. Check the logs above for details."
              echo ""
              echo "üìö Resources for troubleshooting:"
              echo "   - Setup guide: docs/SOCIAL_TOKENS.md"
              echo "   - Instagram: docs/INSTAGRAM_INTEGRATION.md"
              echo "   - TikTok: docs/TIKTOK_INTEGRATION.md"
              exit 1
            fi
