# Main domain - public-facing Link-in-Bio site
# Replace 'festas-builds.com' with your actual domain
festas-builds.com {
    tls eric@festas-builds.com
    reverse_proxy web:8000
}

# Admin subdomain - administrative interface
# Replace 'festas-builds.com' with your actual domain
admin.festas-builds.com {
    tls eric@festas-builds.com
    reverse_proxy web:8000
}

# RigPilot subdomain - PC Builder application
# The rigpilot container must join the 'caddy-network' external network
rigpilot.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    # Cache static Next.js assets with immutable cache headers
    @static path /_next/static/*
    header @static Cache-Control "public, max-age=31536000, immutable"
    reverse_proxy rigpilot:3000
}

# ImmoCalc subdomain - Immobilien Investment Calculator
# The immocalc container must join the 'caddy-network' external network
immocalc.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    # Cache static Next.js assets with immutable cache headers
    @static path /_next/static/*
    header @static Cache-Control "public, max-age=31536000, immutable"
    reverse_proxy immocalc:3000
}

# Minecraft Server Website - public landing page for the Minecraft server
# The minecraft-web container must join the 'caddy-network' external network
mc.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    
    # Console static assets - use revalidation-based caching
    # Browsers will check if files changed (ETag/Last-Modified) but use cache if unchanged
    # This ensures users always get fresh CSS/JS after deployments
    @console_assets {
        path /console/*.css /console/*.js /console/css/* /console/js/*
    }
    header @console_assets Cache-Control "public, max-age=0, must-revalidate"
    
    # Console HTML files - never cache, always fetch fresh
    @console_html {
        path /console/*.html /console/
    }
    header @console_html Cache-Control "no-cache, no-store, must-revalidate"
    header @console_html Pragma "no-cache"
    
    # Static website assets (images, fonts) - long cache, these rarely change
    # Exclude console path to not override the above rules
    @website_static {
        path *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
        not path /console/*
    }
    header @website_static Cache-Control "public, max-age=31536000, immutable"
    
    # API routes for console backend
    handle /api* {
        reverse_proxy minecraft-console:3001
    }
    
    # Console routes (with WebSocket support for real-time logs)
    handle /console* {
        reverse_proxy minecraft-console:3001
    }
    
    # Socket.io WebSocket connections for real-time features
    handle /socket.io* {
        reverse_proxy minecraft-console:3001
    }
    
    # Everything else goes to the static website
    handle {
        reverse_proxy minecraft-web:80
    }
}

# BlueMap - Live 3D server map
mc-map.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    
    # Cache map tiles aggressively
    @tiles path /maps/*/assets/*
    header @tiles Cache-Control "public,max-age=3600"
    
    reverse_proxy minecraft-server:8100
}

# Plan Analytics - Player statistics dashboard
mc-stats.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    
    reverse_proxy minecraft-server:8804 {
        # Enable X-Forwarded-For header for Plan
        header_up X-Forwarded-For {remote_host}
    }
}

# Cosmic Survivor Game - browser-based space survival game
# The cosmic-survivor container must join the 'caddy-network' external network
cs.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    # Cache static game assets with long expiry
    @static path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.mp3 *.ogg *.wav
    header @static Cache-Control "public, max-age=31536000, immutable"
    reverse_proxy cosmic-survivor:80
}

# Pterodactyl Panel - Game Server Management
# Panel runs on Nginx internally on port 8080, Caddy handles SSL
panel.festas-builds.com {
    tls eric@festas-builds.com
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy same-origin
    }
    
    # Reverse proxy to Nginx (running on host, not in Docker)
    # Uses host.docker.internal to reach host from container
    reverse_proxy host.docker.internal:8080
}
